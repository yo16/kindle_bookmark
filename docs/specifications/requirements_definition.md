# Kindle蔵書管理システム 要件定義書

## 1. プロジェクト概要

### 1.1 目的
PC版Kindleアプリの蔵書をブラウザ上で一覧表示し、選択した書籍をPC版Kindleアプリで開くことができるローカル蔵書管理システムを構築する。

### 1.2 システム名称
Kindle Bookmark Manager

### 1.3 対象ユーザー
- 個人利用（単一ユーザー）
- Windows環境でPC版Kindleアプリを使用している利用者

### 1.4 開発フェーズ
- **フェーズ1（MVP）**: 基本機能のシンプル実装
- **フェーズ2**: 基本機能拡張（表紙画像表示、タグ機能）
- **フェーズ3**: パフォーマンス最適化（キャッシュ機構、差分同期）

---

## 2. システム構成

### 2.1 アーキテクチャ
- **クライアント**: React with TypeScript（ブラウザ上で動作）
- **サーバー**: Node.js + Express with TypeScript（ローカルHTTPサーバー）
- **データベース**: SQLite（システム独自データ管理用）
- **将来的な配布形態**: Electron（クライアント・サーバー統合版）

### 2.2 動作環境
- **OS**: Windows 10/11
- **必須ソフトウェア**: PC版Kindleアプリ
- **ブラウザ**: Chrome、Edge、Firefox（最新版）
- **Node.js**: v18以上
- **TypeScript**: v5.0以上

---

## 3. データソース

### 3.1 Kindle蔵書データ
**ファイルパス**:
- メタデータ: `C:\Users\{username}\AppData\Local\Amazon\Kindle\Cache\KindleSyncMetadataCache.xml` (テスト: `sample_file/KindleSyncMetadataCache.xml`)
- コレクション情報: `C:\Users\{username}\AppData\Local\Amazon\Kindle\Cache\db\synced_collections.db` (テスト: `sample_file/synced_collections.db`)

**取得タイミング**:
- システム起動時
- ユーザーが「同期」ボタンを押下時

**取得情報**:
- ASIN（書籍識別子）
- タイトル
- 著者名
- コレクション情報

### 3.2 システム独自データ
**保存先**: アプリケーション内のSQLiteデータベース

**管理情報**（フェーズ2で実装）:
- タグ情報（書籍ASINと紐付け）

---

## 4. 機能要件

### 4.1 フェーズ1（MVP）機能

#### 4.1.1 データ同期機能
- **自動同期**: システム起動時にKindleキャッシュファイルを自動読み込み
- **手動同期**: 「同期」ボタンによる手動データ更新
- **パス自動検出**: Kindleキャッシュファイルのパスを自動検出

#### 4.1.2 蔵書一覧表示
**表示項目**:
- タイトル（全文表示、必要に応じて折り返し）
- 著者名
- コレクション名
- 表紙画像（Phase1ではプレースホルダー表示）

**表示モード**:
- グリッド表示（カード形式）
- リスト表示（テーブル形式）
- 表示モード切り替え機能

#### 4.1.3 検索機能
- **検索対象**: タイトル（部分一致）
- **リアルタイム検索**: 入力と同時に結果を絞り込み

#### 4.1.4 ソート機能
- **ソート項目**: タイトル
- **ソート順**: 昇順/降順切り替え可能
- **実装**: Phase1ではクライアントサイドでのメモリソート

#### 4.1.5 フィルタリング機能
- **コレクション別フィルター**: 特定コレクションの書籍のみ表示
- **複数条件の組み合わせ**: 検索とフィルターの併用可能
- **実装**: Phase1ではクライアントサイドでのシンプルフィルタリング

#### 4.1.6 Kindleアプリ連携
- **書籍を開く**: クリック時にPC版Kindleアプリで該当書籍を開く
- **URLスキーム使用**: `kindle://book?action=open&asin={ASIN}`
- **アプリ起動**: Kindleアプリが起動していない場合は自動起動

### 4.2 フェーズ2機能（基本機能拡張）

#### 4.2.1 表紙画像表示
- **画像取得元**: Amazon API または Google Books API
- **キャッシュ機能**: 取得した画像をローカル保存
- **遅延読み込み**: スクロール時に必要な画像のみ取得

#### 4.2.2 タグ機能
- **複数タグ付与**: 1冊の書籍に複数のタグを設定可能
- **自由入力**: ユーザーが任意の文字列でタグを作成
- **タグによる検索**: タグを検索対象に追加
- **タグフィルター**: 特定タグが付いた書籍のみ表示

### 4.3 フェーズ3機能（パフォーマンス最適化）

#### 4.3.1 キャッシュ機構
- **差分同期**: 前回同期時からの変更分のみ処理
- **解析結果キャッシュ**: 重いXML解析結果をSQLiteに保存
- **ファイルタイムスタンプチェック**: 変更検知のための高速判定
- **forceUpdateの真の意味**: キャッシュ無視/活用の切り替え

#### 4.3.2 高速検索
- **フルテキスト検索**: タイトル、著者名の高速検索
- **インデックス最適化**: SQLiteインデックスの活用
- **ページネーション**: 大量データの効率的表示

#### 4.3.3 UI/UX最適化
- **仮想スクロール**: 大量書籍表示時のDOM要素削減
- **遅延読み込み**: 表紙画像の最適化ロード
- **インタラクティブUI**: ローディングステート、プログレスバーの実装

---

## 5. 非機能要件

### 5.1 パフォーマンス目標（Phase別）

#### Phase1（MVP）のシンプル実装
- **起動時間**: 3秒以内（1000冊の蔵書データ読み込み時）
- **同期時間**: 毎回3秒程度（キャッシュなし）
- **検索レスポンス**: 100ms以内（クライアントサイドフィルタリング）
- **表示切り替え**: 500ms以内

#### Phase3の最適化目標
- **起動時間**: 50ms以内（キャッシュヒット時）
- **同期時間**: 500ms以内（差分更新時）
- **検索レスポンス**: 50ms以内（DBインデックス活用）
- **表示切り替え**: 100ms以内

### 5.2 ユーザビリティ
- **直感的操作**: 説明書なしで基本操作が可能
- **エラーハンドリング**: ファイルが見つからない場合の適切なメッセージ表示
- **データ永続性**: アプリケーション再起動後も設定を保持

### 5.3 セキュリティ
- **ローカル動作**: インターネット接続不要（フェーズ1）
- **読み取り専用**: Kindleのシステムファイルは参照のみ
- **データ保護**: ユーザーデータは外部送信しない

### 5.4 拡張性
- **モジュール設計**: 機能追加が容易な構造
- **API設計**: RESTful APIによるクライアント・サーバー分離
- **Electron対応**: 将来的な配布に向けた設計

---

## 6. 画面設計

### 6.1 メイン画面構成
```
┌─────────────────────────────────────────┐
│ [同期] [🔍 検索ボックス] [表示切替] [▼]│
├─────────────────────────────────────────┤
│ フィルター: [全て▼] [コレクション▼]   │
├─────────────────────────────────────────┤
│                                         │
│  ┌──────┐ ┌──────┐ ┌──────┐         │
│  │      │ │      │ │      │         │
│  │ Book │ │ Book │ │ Book │         │
│  │      │ │      │ │      │         │
│  └──────┘ └──────┘ └──────┘         │
│                                         │
└─────────────────────────────────────────┘
```

### 6.2 操作フロー
1. システム起動 → 自動でKindleデータ読み込み
2. 蔵書一覧表示
3. 検索/フィルター/ソートで絞り込み
4. 書籍をクリック → PC版Kindleアプリで開く

---

## 7. API設計概要

### 7.1 エンドポイント一覧
| メソッド | パス | 説明 |
|---------|------|------|
| GET | /api/books | 蔵書一覧取得 |
| POST | /api/sync | データ同期実行 |
| GET | /api/collections | コレクション一覧取得 |
| POST | /api/books/{asin}/open | Kindleアプリで書籍を開く |

### 7.2 データフォーマット
```json
{
  "books": [
    {
      "asin": "B00XXXXX",
      "title": "書籍タイトル",
      "author": "著者名",
      "collections": ["コレクション1", "コレクション2"]
    }
  ]
}
```

---

## 8. 開発スケジュール

### 8.1 フェーズ1（MVP）
**期間**: 2-3週間 - **シンプル実装で最小限の機能を実現**
1. 環境構築・TypeScriptプロジェクトセットアップ（2日）
2. バックエンド基本機能実装（TypeScript, キャッシュなし）（3日）
3. フロントエンド基本UI実装（React + TypeScript）（3日）
4. Kindleアプリ連携機能（2日）
5. 検索・フィルター機能（クライアントサイド）（2日）
6. テスト・バグ修正（2日）

### 8.2 フェーズ2（基本機能拡張）
**期間**: 1-2週間
1. 表紙画像API連携（3日）
2. タグ機能実装（SQLiteテーブル追加）（3日）
3. UI改善・機能統合（2日）

### 8.3 フェーズ3（パフォーマンス最適化）
**期間**: 2-3週間
1. キャッシュ機構設計・実装（5日）
2. 差分同期機能実装（3日）
3. 高速検索機能実装（2日）
4. UI/UX最適化（仮想スクロール等）（2日）
5. パフォーマンステスト・チューニング（2日）

---

## 9. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Kindleファイル形式変更 | 高 | XMLパーサーを柔軟に設計 |
| 大量蔵書でのパフォーマンス | 中 | ページネーション実装 |
| URLスキーム非対応 | 低 | 代替起動方法の調査 |

---

## 10. 制約事項
- Windows環境限定（MacOS/Linux非対応）
- PC版Kindleアプリのインストールが必須
- インターネット接続不要（フェーズ1）
- レスポンシブ対応なし（PC画面専用）

---

## 改訂履歴
| 版 | 日付 | 内容 | 作成者 |
|----|------|------|--------|
| 1.0 | 2025-01-15 | 初版作成 | - |